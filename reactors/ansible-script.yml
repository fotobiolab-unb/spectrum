---
- name: Setup Arduino Environment
  hosts: reactors
  become: yes
  gather_facts: yes
  vars_prompt:
    - name: "GH_TOKEN"
      prompt: "GitHub Token"
      private: true

  tasks:
    - name: Ensure required packages are installed
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - git
        - unzip
      when: ansible_os_family == 'Debian'

    - name: Install Arduino CLI
      shell: >
        BINDIR=/usr/local/bin sh -c "curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh"
      environment:
        DEBIAN_FRONTEND: noninteractive
      when: ansible_os_family == 'Debian'

    - name: Update Arduino library index
      command: arduino-cli lib update-index -v
      when: ansible_os_family == 'Debian'

    - name: Download and install libraries
      get_url:
        url: "https://github.com/fotobiolab-unb/arduino-libraries/archive/v0.zip"
        dest: "/home/pi/libraries.zip"
        headers:
          Authorization: "token {{ GH_TOKEN }}"
      when: ansible_os_family == 'Debian'

    - name: Prepare library folder
      block:

      - name: Delete library folder if exists
        file:
          state: absent
          path: /home/pi/arduino-libraries

      - name: Extract and move libraries
        unarchive:
          remote_src: yes
          src: "/home/pi/libraries.zip"
          dest: "/home/pi"
        when: ansible_os_family == 'Debian'

      - name: Renaming Library folder
        command: mv -f /home/pi/arduino-libraries-0 /home/pi/arduino-libraries

    - name: Download source code
      get_url:
        url: "https://github.com/fotobiolab-unb/spectrum/archive/v0.zip"
        dest: "/home/pi/spectrum.zip"
        headers:
          Authorization: "token {{ GH_TOKEN }}"

    - name: Prepare Spectrum folder
      block:

      - name: Remove Spectrum folder if exists
        file:
          state: absent
          path: /home/pi/spectrum

      - name: Extract and move source code
        unarchive:
          remote_src: yes
          src: "/home/pi/spectrum.zip"
          dest: "/home/pi"

      - name: Renaming Source folder
        command: mv -f /home/pi/spectrum-0 /home/pi/spectrum

    - name: Build image
      shell: >
        arduino-cli compile -b arduino:avr:mega /home/pi/spectrum/src;
        arduino-cli upload -t -b arduino:avr:mega -p "$(arduino-cli board list | grep 'USB' | awk '{print $1}')" /home/pi/spectrum/src
